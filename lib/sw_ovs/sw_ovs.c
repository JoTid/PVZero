//====================================================================================================================//
// File:          sw_ovs.c                                                                                            //
// Description:   Oversampling Unit                                                                                   //
// Author:        Tiderko                                                                                             //
//--------------------------------------------------------------------------------------------------------------------//
//                                                                                                                    //
//====================================================================================================================//


/*--------------------------------------------------------------------------------------------------------------------*\
** Include files                                                                                                      **
**                                                                                                                    **
\*--------------------------------------------------------------------------------------------------------------------*/
#include "sw_ovs.h"


/*--------------------------------------------------------------------------------------------------------------------*\
** Functions                                                                                                          **
**                                                                                                                    **
\*--------------------------------------------------------------------------------------------------------------------*/

//--------------------------------------------------------------------------------------------------------------------//
// McOvsGetResult()                                                                                                   //
//                                                                                                                    //
//--------------------------------------------------------------------------------------------------------------------// 
uint32_t McOvsGetResult(McOvs_ts *ptsOvsV)
{
   uint32_t ulReturnT = 0;

   //--------------------------------------------------------------------------------------------------- 
   // check the provided pointer
   // 
   if (ptsOvsV != (McOvs_ts *)0)
   {
      ulReturnT = ptsOvsV->ulResult;
   }

   return (ulReturnT);
}


//--------------------------------------------------------------------------------------------------------------------//
// McOvsInit()                                                                                                        //
//                                                                                                                    //
//--------------------------------------------------------------------------------------------------------------------// 
int32_t McOvsInit(McOvs_ts *ptsOvsV, uint8_t ubBitNumberV)
{
   int32_t slReturnT = 0;

   //--------------------------------------------------------------------------------------------------- 
   // check the provided pointer
   // 
   if (ptsOvsV == (McOvs_ts *)0)
   {
      slReturnT = -1;
   }

   //--------------------------------------------------------------------------------------------------- 
   // number of bits is limited to 16, to avoid overflows at sum calculation
   //
   else if (ubBitNumberV > 16)
   {
      slReturnT = -2;
   }

   //--------------------------------------------------------------------------------------------------- 
   // initialise values for sample process
   //
   else
   {
      ptsOvsV->ubBitNumber = ubBitNumberV;
      ptsOvsV->ulRatioCountMax = 1<<(2*ubBitNumberV);
      ptsOvsV->ulRatioCount = ptsOvsV->ulRatioCountMax;
      ptsOvsV->ulInputSum = 0;
      ptsOvsV->ulResult = 0;
   }

   return (slReturnT);
}

//--------------------------------------------------------------------------------------------------------------------//
// McOvsSample()                                                                                                      //
//                                                                                                                    //
//--------------------------------------------------------------------------------------------------------------------// 
bool McOvsSample(McOvs_ts *ptsOvsV, uint32_t ulInputV)
{
   bool btReturnT = true; 

   //--------------------------------------------------------------------------------------------------- 
   // check the provided pointer
   // 
   if (ptsOvsV == (McOvs_ts *)0)
   {
      btReturnT = false;
   }

   //--------------------------------------------------------------------------------------------------- 
   // perform sample process
   // 
   else
   {
      //------------------------------------------------------------------------------------------- 
      // update sum and ratio count
      //
      ptsOvsV->ulInputSum += ulInputV;
      ptsOvsV->ulRatioCount--;

      //------------------------------------------------------------------------------------------- 
      // check the sum is ready for calculation of final value
      //
      if (ptsOvsV->ulRatioCount > 0)
      {
         btReturnT = false;
      }
      else 
      {  
         //----------------------------------------------------------------------------------- 
         // reset the ratio count and calc the result 
         //
         ptsOvsV->ulResult = ptsOvsV->ulInputSum >> ptsOvsV->ubBitNumber;
         ptsOvsV->ulRatioCount = ptsOvsV->ulRatioCountMax;
         ptsOvsV->ulInputSum = 0;
      }
   }

   return (btReturnT);
}
